<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extraction Viewer - PDF Schedule Extractor</title>
    
    <!-- Data placeholder for export injection -->
    <script>
        // This will be replaced during export with actual project data
        window.EMBEDDED_PROJECT_DATA = /*DATA_PLACEHOLDER*/null;
    </script>
    
    <!-- Shared Styles -->
    <link rel="stylesheet" href="shared-styles.css">
    
    <!-- Shared Utilities -->
    <script src="shared-utils.js"></script>
    
    <style>
        /* Extraction Viewer Template Specific Styles */

        /* 200% Scaled Cards - Extraction Viewer Specific */
        .extractions-grid {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .extraction-card {
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .extraction-thumbnail {
            height: 400px;
        }

        /* 200% Scaled Text Elements */
        .extraction-title {
            margin-bottom: 16px;
            font-size: 1.8em;
        }

        .extraction-meta {
            gap: 16px;
            margin-bottom: 20px;
        }

        .meta-tag {
            padding: 6px 16px;
            border-radius: 16px;
            font-size: 1.1em;
        }

        /* Full-Screen Modal Override */
        .modal {
            background: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            border-radius: 0;
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .extraction-image-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .extraction-image-container img {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .ocr-section {
            margin-top: 20px;
        }

        .ocr-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .ocr-content {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .ocr-content pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }

        /* 200% Scaled File Links */
        .file-links {
            margin-top: 30px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .file-link {
            padding: 12px 24px;
            font-size: 1.2em;
        }

        /* File loading - using shared styles */

        /* Responsive design overrides */
        @media (max-width: 768px) {
            .extractions-grid {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 10px;
            }
            
            .extraction-thumbnail {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Extraction Viewer</h1>
        <div class="project-info" id="project-info">Loading project information...</div>
    </div>

    <!-- Fallback file loading UI -->
    <div class="file-loader" id="file-loader" style="display: none;">
        <div class="file-loader-content">
            <h3>üìÅ Load Project Data</h3>
            <p>Drag and drop your <code>project_data.json</code> file here, or click to browse:</p>
            <div class="file-drop-zone" id="file-drop-zone">
                <div class="drop-zone-content">
                    <div class="drop-icon">üìÑ</div>
                    <div class="drop-text">Drop project_data.json here</div>
                    <div class="drop-or">or</div>
                    <button class="browse-button" id="browse-button">Choose File</button>
                </div>
            </div>
            <input type="file" id="file-input" accept=".json" style="display: none;">
        </div>
    </div>

    <div class="main-container">
        <div class="equipment-sidebar">
            <h3>Equipment Types</h3>
            <div id="equipment-types-list">
                <div class="equipment-type active" data-equipment="all">
                    <span>All Equipment</span>
                    <span class="equipment-count" id="total-count">0</span>
                </div>
            </div>
        </div>

        <div class="content-area">
            <div class="extractions-grid" id="extractions-container">
                <div class="no-results">
                    <h3>Loading extractions...</h3>
                    <p>Please wait while we load your extraction data.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for detailed view -->
    <div class="modal" id="extraction-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Extraction Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Application state
        let projectData = null;
        let extractionsData = [];
        let filteredExtractions = [];
        let currentEquipmentFilter = 'all';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadProjectData();
        });

        // Load project data from project_data.json
        async function loadProjectData() {
            // First priority: Use embedded data if available (injected during export)
            if (window.EMBEDDED_PROJECT_DATA !== null) {
                projectData = window.EMBEDDED_PROJECT_DATA;
                console.log('Using embedded project data:', projectData);
                updateProjectInfo();
                processProjectData();
                return;
            }
            
            // Second priority: Try fetch method for server-based viewing
            try {
                const response = await fetch('project_data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                projectData = await response.json();
                console.log('Loaded project data via fetch:', projectData);
                updateProjectInfo();
                processProjectData();
                return;
                
            } catch (error) {
                console.error('Error loading project data:', error);
                
                // Third priority: Show file loading UI for manual loading
                showFileLoader();
            }
        }

        // Helper function to update project info display
        function updateProjectInfo() {
            const projectInfo = document.getElementById('project-info');
            projectInfo.textContent = `${projectData.project || 'Untitled Project'} - ${projectData.totalExtractions || 0} extractions - Exported: ${projectData.exportDate || 'Unknown'}`;
        }

        // Show the file loading interface
        function showFileLoader() {
            document.getElementById('file-loader').style.display = 'block';
            document.getElementById('main-container').style.display = 'none';
            
            // Update project info to show loading state
            const projectInfo = document.getElementById('project-info');
            projectInfo.textContent = 'Please load your project data file below';
            
            // Set up file loading functionality
            setupFileLoader();
        }

        // Set up drag & drop and file input functionality
        function setupFileLoader() {
            const fileInput = document.getElementById('file-input');
            const browseButton = document.getElementById('browse-button');
            const dropZone = document.getElementById('file-drop-zone');
            
            // Browse button click
            browseButton.addEventListener('click', () => {
                fileInput.click();
            });
            
            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    loadJsonFile(e.target.files[0]);
                }
            });
            
            // Drag and drop events
            dropZone.addEventListener('click', () => {
                fileInput.click();
            });
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    loadJsonFile(files[0]);
                }
            });
        }

        // Load JSON file from file input
        function loadJsonFile(file) {
            if (!file.name.toLowerCase().endsWith('.json')) {
                alert('Please select a valid JSON file.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    projectData = JSON.parse(e.target.result);
                    console.log('Loaded project data from file:', projectData);
                    
                    // Hide file loader and show main content
                    document.getElementById('file-loader').style.display = 'none';
                    document.getElementById('main-container').style.display = 'flex';
                    
                    // Update project info and process data
                    updateProjectInfo();
                    processProjectData();
                    
                } catch (error) {
                    console.error('Error parsing JSON file:', error);
                    alert('Error reading JSON file. Please make sure it\'s a valid project_data.json file.');
                }
            };
            
            reader.readAsText(file);
        }

        // Process project data and create flat extraction array
        function processProjectData() {
            extractionsData = [];
            
            if (projectData.equipment) {
                // New format: equipment-grouped
                Object.entries(projectData.equipment).forEach(([equipmentType, extractions]) => {
                    extractions.forEach(extraction => {
                        extractionsData.push({
                            ...extraction,
                            equipmentType: equipmentType
                        });
                    });
                });
            }
            
            console.log(`Processed ${extractionsData.length} extractions`);
            
            // Update equipment types and render
            renderEquipmentTypes();
            applyFilter();
        }

        // Render equipment types in sidebar
        function renderEquipmentTypes() {
            const container = document.getElementById('equipment-types-list');
            const allOption = container.querySelector('[data-equipment="all"]');
            
            // Clear existing equipment types (keep "All Equipment")
            const equipmentTypes = container.querySelectorAll('[data-equipment]:not([data-equipment="all"])');
            equipmentTypes.forEach(el => el.remove());
            
            // Get unique equipment types from data
            const types = [...new Set(extractionsData.map(e => e.equipmentType))].sort();
            
            // Update total count
            const totalCount = document.getElementById('total-count');
            totalCount.textContent = extractionsData.length;
            
            // Add equipment type options
            types.forEach(type => {
                const count = extractionsData.filter(e => e.equipmentType === type).length;
                
                const element = document.createElement('div');
                element.className = 'equipment-type';
                element.dataset.equipment = type;
                element.innerHTML = `
                    <span>${type}</span>
                    <span class="equipment-count">${count}</span>
                `;
                element.addEventListener('click', () => filterByEquipment(type));
                
                container.appendChild(element);
            });
        }

        // Filter extractions by equipment type
        function filterByEquipment(equipmentType) {
            currentEquipmentFilter = equipmentType;
            
            // Update active state in sidebar
            const equipmentElements = document.querySelectorAll('.equipment-type');
            equipmentElements.forEach(el => {
                el.classList.toggle('active', el.dataset.equipment === equipmentType);
            });
            
            applyFilter();
        }

        // Apply current filters
        function applyFilter() {
            filteredExtractions = extractionsData.filter(extraction => {
                if (currentEquipmentFilter === 'all') return true;
                return extraction.equipmentType === currentEquipmentFilter;
            });
            
            renderExtractions();
        }

        // Render extractions grid
        function renderExtractions() {
            const container = document.getElementById('extractions-container');
            
            if (filteredExtractions.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <h3>No extractions found</h3>
                        <p>No extractions match the current filter.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            filteredExtractions.forEach(extraction => {
                const card = createExtractionCard(extraction);
                container.appendChild(card);
            });
        }

        // Create extraction card element
        function createExtractionCard(extraction) {
            const card = document.createElement('div');
            card.className = 'extraction-card';
            card.onclick = () => showExtractionDetails(extraction);
            
            const imagePath = extraction.files?.image || '';
            
            card.innerHTML = `
                <div class="extraction-thumbnail">
                    ${imagePath ? `<img src="${imagePath}" alt="${extraction.extractionName}" onerror="this.style.display='none';">` : '<div style="color: #6c757d;">No image</div>'}
                </div>
                <div class="extraction-title">${extraction.extractionName || 'Untitled'}</div>
                <div class="extraction-meta">
                    <span class="meta-tag equipment">${extraction.equipmentType}</span>
                    <span class="meta-tag type">${extraction.extractionType || 'Unknown'}</span>
                    ${extraction.pageNumber ? `<span class="meta-tag">Page ${extraction.pageNumber}</span>` : ''}
                </div>
            `;
            
            return card;
        }

        // Show extraction details in modal
        async function showExtractionDetails(extraction) {
            const modal = document.getElementById('extraction-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = extraction.extractionName || 'Extraction Details';
            
            let modalContent = `
                <div class="extraction-image-container">
                    ${extraction.files?.image ? `<img src="${extraction.files.image}" alt="${extraction.extractionName}">` : '<p>No image available</p>'}
                </div>
                
                <div class="extraction-metadata">
                    <p><strong>Equipment Type:</strong> ${extraction.equipmentType}</p>
                    <p><strong>Extraction Type:</strong> ${extraction.extractionType || 'Unknown'}</p>
                    ${extraction.pageNumber ? `<p><strong>Page:</strong> ${extraction.pageNumber}</p>` : ''}
                    ${extraction.description ? `<p><strong>Description:</strong> ${extraction.description}</p>` : ''}
                </div>
            `;
            
            // Add OCR data if available
            if (extraction.ocrData || extraction.files?.tableData) {
                modalContent += `<div class="ocr-section">`;
                
                if (extraction.ocrData?.rawText) {
                    modalContent += `
                        <h3>OCR Text Data</h3>
                        <div class="ocr-content">
                            <pre>${extraction.ocrData.rawText}</pre>
                        </div>
                    `;
                } else if (extraction.files?.tableData) {
                    modalContent += `
                        <h3>OCR Data Available</h3>
                        <p>Click the links below to view the OCR data files.</p>
                    `;
                }
                
                modalContent += `</div>`;
            }
            
            // Add file download links
            if (extraction.files) {
                modalContent += `
                    <div class="file-links">
                        ${extraction.files.image ? `<a href="${extraction.files.image}" class="file-link" download>Download Image</a>` : ''}
                        ${extraction.files.tableData ? `<a href="${extraction.files.tableData}" class="file-link" download>Download Table Data</a>` : ''}
                        ${extraction.files.textData ? `<a href="${extraction.files.textData}" class="file-link" download>Download Text Data</a>` : ''}
                    </div>
                `;
            }
            
            modalBody.innerHTML = modalContent;
            modal.style.display = 'flex';
        }

        // Close modal
        function closeModal() {
            ModalUtils.close('extraction-modal');
        }

        // Close modal when clicking outside
        document.getElementById('extraction-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>